<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èµ·é£æ‰“å¡ä¼åˆ’ Â· å…¨åŠŸèƒ½ç‰ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --primary: #007bff; --bg: #f4f7f6; }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }

/* å·²è¾¾æˆçš„æˆå°±ï¼šé‡‘è‰²è¾¹æ¡†ï¼Œäº®è‰²èƒŒæ™¯ */
.achievement-item.unlocked {
  background: #fffde7;
  border: 2px solid #ffd700;
  opacity: 1;
}

/* æœªè¾¾æˆçš„æˆå°±ï¼šç°è‰²èƒŒæ™¯ï¼ŒåŠé€æ˜ */
.achievement-item.locked {
  background: #f5f5f5;
  border: 2px dashed #ccc;
  opacity: 0.7;
  color: #888;
}

/* è¿›åº¦æ¡æ–‡å­— */
.progress-text {
  font-size: 11px;
  color: #ff9800;
  font-weight: bold;
}

    .container { max-width: 500px; margin: 0 auto; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
    h1, h2, h3 { margin-top: 0; text-align: center; }
    input, select, button { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    
    .nav { display: flex; gap: 10px; margin-bottom: 20px; }
    .nav button { flex: 1; background: #eee; color: #666; font-size: 14px; }
    .nav button.active { background: var(--primary); color: white; }

    .achievement-item { display: flex; align-items: center; background: #fffde7; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #fff9c4; }
    .rank-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
    .announcement { background: #e8f5e9; padding: 15px; border-radius: 8px; font-size: 14px; border-left: 4px solid #4caf50; }
    .hidden { display: none !important; }
    .tag { font-size: 12px; background: #eee; padding: 2px 6px; border-radius: 4px; }
  </style>
</head>
<body>

<div class="container">
  <!-- ç™»å½•æ¡† -->
  <div id="loginSection" class="card">
    <h1>ğŸš€ èµ·é£æ‰“å¡</h1>
    <input id="nickname" placeholder="è¾“å…¥æ˜µç§°" />
    <input id="qq" placeholder="è¾“å…¥QQå· (å”¯ä¸€å‡­è¯)" />
    <button id="loginBtn">è¿›å…¥ä¼åˆ’</button>
    <p style="font-size: 12px; color: #999; text-align: center; margin-top: 10px;">ç¬¬ä¸€æ¬¡è¾“å…¥å°†è‡ªåŠ¨åˆ›å»ºè´¦å·</p>
  </div>

  <!-- ä¸»ç•Œé¢ (ç™»å½•åæ˜¾ç¤º) -->
  <div id="mainSection" class="hidden">
    <div id="annoBox" class="card announcement">æ­£åœ¨åŠ è½½å…¬å‘Š...</div>

    <div class="nav">
      <button onclick="showPage('checkin')" id="nav-checkin" class="active">æ‰“å¡</button>
      <button onclick="showPage('rank')" id="nav-rank">æ’è¡Œæ¦œ</button>
      <button onclick="showPage('me')" id="nav-me">æˆå°±</button>
    </div>

    <!-- æ‰“å¡é¡µ -->
    <div id="page-checkin" class="page card">
      <h2>æ¬¢è¿, <span id="displayNickname"></span></h2>
      <select id="categorySelect">
        <option value="çœŸäºº">çœŸäººç´ æ ğŸ¬</option>
        <option value="æœ¬å­">çº¸è´¨æœ¬å­ ğŸ“–</option>
        <option value="è§†é¢‘">çŸ­è§†é¢‘ ğŸ“±</option>
        <option value="å…¶ä»–">å…¶ä»–ç±»åˆ« ğŸ’¡</option>
      </select>
      <button id="checkInBtn">ç«‹å³æ‰“å¡ ğŸš€</button>
    </div>

    <!-- æ’è¡Œæ¦œé¡µ -->
    <div id="page-rank" class="page card hidden">
      <h2>æ’è¡Œæ¦œ (å‰10)</h2>
      <div id="rankList">åŠ è½½ä¸­...</div>
    </div>

    <!-- æˆå°±é¡µ -->
    <div id="page-me" class="page card hidden">
      <h2>æˆ‘çš„æˆå°±</h2>
      <div id="achievementsBox">æš‚æ— æˆå°±</div>
      <button onclick="logout()" style="background:#ff5252; margin-top:30px;">é€€å‡ºç™»å½•</button>
    </div>
  </div>
</div>

<script>
  // 1. åˆå§‹åŒ– (å˜é‡åæ”¹ä¸º supabaseClient é¿å…å†²çª)
  const SUPABASE_URL = 'https://bunogkfayqafxghedrdt.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_9zBGizofsJmjERXnN68epQ_L-cGXu2F';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUser = null;

  // 2. ç™»å½•é€»è¾‘
  async function login() {
    const nickname = document.getElementById('nickname').value.trim();
    const qq = document.getElementById('qq').value.trim();
    const btn = document.getElementById('loginBtn');

    if (!nickname || !qq) return alert('è¯·å®Œæ•´å¡«å†™æ˜µç§°å’ŒQQå·');

    btn.disabled = true;
    btn.innerText = 'æ­£åœ¨è¿æ¥...';

    try {
      // æŸ¥æ‰¾ç”¨æˆ·
      let { data: user, error: fetchError } = await supabaseClient
        .from('users')
        .select('*')
        .eq('qq', qq)
        .maybeSingle();

      if (fetchError) throw fetchError;

      if (!user) {
        // æ³¨å†Œ
        const { data: newUser, error: insError } = await supabaseClient
          .from('users')
          .insert([{ nickname, qq }])
          .select()
          .single();
        if (insError) throw insError;
        user = newUser;
      }

      currentUser = user;
      localStorage.setItem('qifei_user', JSON.stringify(user));
      initApp();
    } catch (err) {
      console.error(err);
      alert('æ— æ³•è¿›å…¥: ' + (err.message || 'ç½‘ç»œè¿æ¥å¤±è´¥'));
    } finally {
      btn.disabled = false;
      btn.innerText = 'è¿›å…¥ä¼åˆ’';
    }
  }

  // 3. åˆå§‹åŒ–åº”ç”¨ç•Œé¢
  function initApp() {
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('mainSection').classList.remove('hidden');
    document.getElementById('displayNickname').innerText = currentUser.nickname;
    loadAllData();
  }

  // 4. åŠ è½½æ•°æ®
  async function loadAllData() {
    if (!currentUser) return;

    // åŠ è½½å…¬å‘Š
    const { data: annos } = await supabaseClient.from('announcements').select('content').eq('is_active', true).limit(1);
    document.getElementById('annoBox').innerText = annos?.[0]?.content || "æ¬¢è¿æ¥åˆ°èµ·é£æ‰“å¡ä¼åˆ’ï¼";

    // åŠ è½½æ’è¡Œ (å·²ä¿®å¤æ’åºé€»è¾‘)
    const { data: ranks, error: rankError } = await supabaseClient
      .from('user_stats')
      .select('*')
      .order('total_count', { ascending: false }) // è¿™é‡Œçš„ä»£ç è®©æ¬¡æ•°å¤šçš„æ’åœ¨å‰é¢
      .limit(10);

    if (rankError) {
      console.error('æ’è¡ŒåŠ è½½å¤±è´¥:', rankError);
    } else if (ranks) {
      document.getElementById('rankList').innerHTML = ranks.map((u, i) => `
        <div class="rank-item">
          <span>${i+1}. ${u.nickname}</span>
          <strong>${u.total_count}æ¬¡</strong>
        </div>
      `).join('');
    }

    // --- ä¿®æ”¹åçš„æˆå°±åŠ è½½é€»è¾‘ ---
    
    // 1. è·å–å½“å‰ç”¨æˆ·çš„æœ€æ–°ç»Ÿè®¡æ•°æ®ï¼ˆä¸ºäº†æ˜¾ç¤ºè¿›åº¦ï¼Œæ¯”å¦‚ 3/5ï¼‰
    const { data: userStat } = await supabaseClient
      .from('user_stats')
      .select('total_count')
      .eq('id', currentUser.id)
      .single();
    const myCount = userStat?.total_count || 0;

    // 2. è·å–æ‰€æœ‰å®šä¹‰çš„æˆå°±ï¼ˆæŒ‰é—¨æ§›ä»ä½åˆ°é«˜æ’ï¼‰
    const { data: allAchievements } = await supabaseClient
      .from('achievements')
      .select('*')
      .order('threshold', { ascending: true });

    // 3. è·å–ç”¨æˆ·å·²ç»è·å¾—çš„æˆå°± ID åˆ—è¡¨
    const { data: myEarned } = await supabaseClient
      .from('user_achievements')
      .select('achievement_id')
      .eq('user_id', currentUser.id);
    
    const earnedIds = myEarned ? myEarned.map(item => item.achievement_id) : [];

    // 4. æ¸²æŸ“æˆå°±å¢™
    if (allAchievements) {
      document.getElementById('achievementsBox').innerHTML = allAchievements.map(ach => {
        const isUnlocked = earnedIds.includes(ach.id);
        const statusClass = isUnlocked ? 'unlocked' : 'locked';
        const icon = isUnlocked ? 'ğŸ†' : 'ğŸ”’';
        
        // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯” (æœ€é«˜ 100%)
        const progress = Math.min(Math.floor((myCount / ach.threshold) * 100), 100);
        
        return `
          <div class="achievement-item ${statusClass}">
            <div style="font-size: 24px; margin-right: 15px;">${icon}</div>
            <div style="flex: 1;">
              <strong>${ach.title}</strong> 
              ${!isUnlocked ? `<span class="progress-text">(${myCount}/${ach.threshold})</span>` : ''}
              <br>
              <small>${ach.description}</small>
              ${!isUnlocked ? `
                <div style="width:100%; background:#ddd; height:4px; margin-top:5px; border-radius:2px;">
                  <div style="width:${progress}%; background:#ff9800; height:100%; border-radius:2px;"></div>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
  }

  // 5. æ‰“å¡é€»è¾‘
  async function doCheckIn() {
    const category = document.getElementById('categorySelect').value;
    const btn = document.getElementById('checkInBtn');
    
    btn.disabled = true;
    try {
      const { error } = await supabaseClient.from('records').insert([
        { user_id: currentUser.id, category: category }
      ]);
      if (error) {
        if (error.code === '23505') alert('ä»Šå¤©è¿™ä¸ªç±»åˆ«ä½ å·²ç»æ‰“è¿‡å¡å•¦ï¼');
        else throw error;
      } else {
        alert('æ‰“å¡æˆåŠŸï¼');
        loadAllData();
      }
    } catch (err) {
      alert('é”™è¯¯: ' + err.message);
    } finally {
      btn.disabled = false;
    }
  }

  // é¡µé¢åˆ‡æ¢
  function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
    document.getElementById('page-' + pageId).classList.remove('hidden');
    document.getElementById('nav-' + pageId).classList.add('active');
  }

  function logout() {
    localStorage.clear();
    location.reload();
  }

  // è‡ªåŠ¨ç™»å½•
  const savedUser = localStorage.getItem('qifei_user');
  if (savedUser) {
    currentUser = JSON.parse(savedUser);
    initApp();
  }

  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('checkInBtn').addEventListener('click', doCheckIn);
</script>

</body>
</html>