<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èµ·é£æ‰“å¡ä¼åˆ’ Â· å¯†ç ä¿æŠ¤ç‰ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --primary: #007bff; --bg: #f4f7f6; --success: #28a745; }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; }
    .container { max-width: 500px; margin: 0 auto; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
    h1, h2, h3 { margin-top: 0; text-align: center; }
    input, select, button { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; }
    
    .nav { display: flex; gap: 8px; margin-bottom: 20px; }
    .nav button { flex: 1; background: #eee; color: #666; font-size: 13px; padding: 10px 5px; }
    .nav button.active { background: var(--primary); color: white; }

    .rank-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
    .stat-card big { display: block; font-size: 24px; font-weight: bold; color: var(--primary); }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
    .cal-day { aspect-ratio: 1/1; background: #eee; border-radius: 3px; font-size: 10px; display: flex; align-items: center; justify-content: center; }
    .cal-day.active { background: var(--success); color: white; }
    .achievement-item { display: flex; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; }
    .achievement-item.unlocked { background: #fffde7; border-color: #ffd700; }
    .achievement-item.locked { opacity: 0.5; background: #fafafa; }
    .hidden { display: none !important; }
    .back-btn { background: #666; margin-bottom: 15px; }
    .tips { font-size: 12px; color: #999; text-align: center; margin-top: 10px; }
  </style>
</head>
<body>

<div class="container">
  <!-- ç™»å½•/æ³¨å†Œæ¡† -->
  <div id="loginSection" class="card">
    <h1>ğŸš€ èµ·é£æ‰“å¡</h1>
    <input id="username" placeholder="è´¦å· (ç™»å½•å‡­è¯)" />
    <input id="password" type="password" placeholder="å¯†ç " />
    <input id="nickname" placeholder="æ˜µç§° (ä»…é¦–æ¬¡æ³¨å†Œéœ€è¦)" />
    <button id="loginBtn">è¿›å…¥ä¼åˆ’</button>
    <p class="tips">é¦–æ¬¡è¾“å…¥è´¦å·å°†è‡ªåŠ¨æ³¨å†Œ</p>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="mainSection" class="hidden">
    <div class="nav">
      <button onclick="showPage('checkin')" id="nav-checkin" class="active">æ‰“å¡</button>
      <button onclick="showPage('rank')" id="nav-rank">æ’è¡Œæ¦œ</button>
      <button onclick="showPage('me')" id="nav-me">æˆå°±</button>
      <button onclick="showPage('admin')" id="nav-admin" class="hidden">ç®¡ç†</button>
    </div>

    <!-- æ‰“å¡é¡µ -->
    <div id="page-checkin" class="page card">
      <h2>æ¬¢è¿, <span id="displayNickname"></span></h2>
      <select id="categorySelect">
        <option value="çœŸäºº">çœŸäººç´ æ ğŸ¬</option>
        <option value="æœ¬å­">çº¸è´¨æœ¬å­ ğŸ“–</option>
        <option value="è§†é¢‘">çŸ­è§†é¢‘ ğŸ“±</option>
      </select>
      <button id="checkInBtn">ç«‹å³æ‰“å¡ ğŸš€</button>
      <div id="annoBox" style="margin-top:20px; font-size:13px; color:#666;"></div>
    </div>

    <!-- æ’è¡Œæ¦œ/ç®¡ç†/è¯¦æƒ…é¡µ (é€»è¾‘åŒå‰ï¼Œæ­¤å¤„çœç•¥é‡å¤HTMLç»“æ„ä»¥èŠ‚çœç©ºé—´ï¼Œå»ºè®®ä¿ç•™ä½ ä¸Šä¸ªç‰ˆæœ¬çš„ç»“æ„) -->
    <!-- ... (ä¿ç•™ä½ ä¹‹å‰çš„ page-rank, page-me, page-profile, page-admin ç»“æ„) ... -->
    <div id="page-rank" class="page card hidden">
      <h2>æ’è¡Œæ¦œ</h2>
      <div id="rankList"></div>
    </div>
    
    <div id="page-me" class="page card hidden">
      <h2>æˆ‘çš„æˆå°±</h2>
      <div id="achievementsBox"></div>
      <button onclick="logout()" style="background:#ff5252; margin-top:20px;">é€€å‡ºç™»å½•</button>
    </div>

    <div id="page-profile" class="page card hidden">
      <button class="back-btn" onclick="showPage('rank')">â† è¿”å›</button>
      <h2 id="profName">èµ„æ–™</h2>
      <div class="stat-grid">
        <div class="stat-card"><small>æ€»è®¡</small><big id="profTotal">0</big></div>
        <div class="stat-card"><small>æœ¬æœˆ</small><big id="profMonth">0</big></div>
      </div>
      <h3>æœ¬æœˆåˆ†å¸ƒ</h3><div id="calendar" class="calendar-grid"></div>
      <h3>æœˆåº¦ç»Ÿè®¡</h3><div id="monthlyStats"></div>
    </div>

    <div id="page-admin" class="page card hidden">
      <h2>ç”¨æˆ·ç®¡ç†</h2>
      <div id="adminUserList"></div>
    </div>

  </div>
</div>

<script>
  const SUPABASE_URL = 'https://bunogkfayqafxghedrdt.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_9zBGizofsJmjERXnN68epQ_L-cGXu2F';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUser = null;

  async function login() {
    const userVal = document.getElementById('username').value.trim();
    const passVal = document.getElementById('password').value.trim();
    const nickVal = document.getElementById('nickname').value.trim();

    if (!userVal || !passVal) return alert('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ');

    try {
      // 1. æŸ¥æ‰¾è´¦å·
      let { data: user } = await supabaseClient.from('users').select('*').eq('username', userVal).maybeSingle();

      if (!user) {
        // 2. è´¦å·ä¸å­˜åœ¨ -> æ³¨å†Œ
        if (!nickVal) return alert('æ–°ç”¨æˆ·è¯·å¡«å†™æ˜µç§°');
        const { data: newUser, error: insError } = await supabaseClient
          .from('users')
          .insert([{ username: userVal, password: passVal, nickname: nickVal }])
          .select().single();
        if (insError) throw insError;
        user = newUser;
        alert('æ³¨å†ŒæˆåŠŸï¼');
      } else {
        // 3. è´¦å·å·²å­˜åœ¨ -> éªŒè¯å¯†ç 
        if (user.password !== passVal) {
          return alert('å¯†ç é”™è¯¯ï¼');
        }
      }

      currentUser = user;
      localStorage.setItem('qifei_user', JSON.stringify(user));
      initApp();
    } catch (e) { alert(e.message); }
  }

  function initApp() {
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('mainSection').classList.remove('hidden');
    document.getElementById('displayNickname').innerText = currentUser.nickname;
    if (currentUser.role === 'admin') document.getElementById('nav-admin').classList.remove('hidden');
    loadAllData();
  }

  // --- ä»¥ä¸‹é€»è¾‘ä¸ä¸Šä¸ªç‰ˆæœ¬ç›¸åŒï¼Œç¡®ä¿å‡½æ•°åä¸€è‡´ ---
  async function loadAllData() {
    if (!currentUser) return;
    loadRank();
    const { data: annos } = await supabaseClient.from('announcements').select('content').limit(1);
    document.getElementById('annoBox').innerHTML = "ğŸ“¢ å…¬å‘Šï¼š" + (annos?.[0]?.content || "æš‚æ— ");
    
    // æˆå°±è¿›åº¦é€»è¾‘
    const { data: userStat } = await supabaseClient.from('user_stats').select('total_count').eq('id', currentUser.id).single();
    const myCount = userStat?.total_count || 0;
    const { data: allAch } = await supabaseClient.from('achievements').select('*').order('threshold', {ascending:true});
    const { data: myEarned } = await supabaseClient.from('user_achievements').select('achievement_id').eq('user_id', currentUser.id);
    const earnedIds = myEarned?.map(a => a.achievement_id) || [];
    
    if (allAch) {
      document.getElementById('achievementsBox').innerHTML = allAch.map(ach => {
        const isUnlocked = earnedIds.includes(ach.id);
        const progress = Math.min(Math.floor((myCount / ach.threshold) * 100), 100);
        return `<div class="achievement-item ${isUnlocked ? 'unlocked' : 'locked'}">
          <div style="font-size:20px; margin-right:10px;">${isUnlocked ? 'ğŸ†' : 'ğŸ”’'}</div>
          <div style="flex:1;"><strong>${ach.title}</strong><br><small>${ach.description}</small>
          ${!isUnlocked ? `<div style="width:100%; background:#eee; height:4px; margin-top:5px;"><div style="width:${progress}%; background:#ff9800; height:100%;"></div></div>` : ''}
          </div></div>`;
      }).join('');
    }
  }

  async function loadRank() {
    const { data: ranks } = await supabaseClient.from('user_stats').select('*').order('total_count', {ascending:false}).limit(20);
    document.getElementById('rankList').innerHTML = ranks?.map((u, i) => `
      <div class="rank-item" onclick="viewUserProfile('${u.id}', '${u.nickname}')">
        <span>${i+1}. ${u.nickname}</span>
        <strong>${u.total_count}æ¬¡ ></strong>
      </div>
    `).join('') || "æš‚æ— ";
  }

  async function viewUserProfile(uid, uname) {
    showPage('profile');
    document.getElementById('profName').innerText = uname + ' çš„æ—¥å¿—';
    const { data: records } = await supabaseClient.from('records').select('checkin_date').eq('user_id', uid).order('checkin_date', {ascending: false});
    document.getElementById('profTotal').innerText = records?.length || 0;
    const monthMap = {};
    const thisMonth = new Date().toISOString().slice(0, 7);
    let thisMonthCount = 0;
    const checkinDays = new Set();
    records?.forEach(r => {
      const m = r.checkin_date.slice(0, 7);
      monthMap[m] = (monthMap[m] || 0) + 1;
      if (m === thisMonth) { thisMonthCount++; checkinDays.add(parseInt(r.checkin_date.slice(8, 10))); }
    });
    document.getElementById('profMonth').innerText = thisMonthCount;
    document.getElementById('monthlyStats').innerHTML = Object.keys(monthMap).sort().reverse().map(m => `<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #f0f0f0;"><span>${m}</span><strong>${monthMap[m]}æ¬¡</strong></div>`).join('');
    const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
    let calHtml = '';
    for (let i = 1; i <= daysInMonth; i++) calHtml += `<div class="cal-day ${checkinDays.has(i) ? 'active' : ''}">${i}</div>`;
    document.getElementById('calendar').innerHTML = calHtml;
  }

  async function loadAdminUserList() {
    const { data: users } = await supabaseClient.from('users').select('*').order('created_at', {ascending: false});
    document.getElementById('adminUserList').innerHTML = users.map(u => `
      <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
        <div><strong>${u.nickname}</strong><br><small>è´¦å·: ${u.username}</small></div>
        ${u.role !== 'admin' ? `<button onclick="deleteUser('${u.id}')" style="width:auto; background:red; padding:4px 8px; font-size:12px;">åˆ é™¤</button>` : ''}
      </div>
    `).join('');
  }

  async function deleteUser(uid, uname) {
    // 1. å…ˆå¼¹çª—ç¡®è®¤ï¼Œé˜²æ­¢è¯¯åˆ 
    if (!confirm(`ç¡®å®šè¦å½»åº•åˆ é™¤ [${uname}] å—ï¼Ÿ\nè¿™ä¼šåŒæ—¶æŠ¹é™¤ä»–æ‰€æœ‰çš„æ‰“å¡è®°å½•å’Œæˆå°±ã€‚`)) return;
  
    // 2. äº¤äº’ä¼˜åŒ–ï¼šç«‹åˆ»æ‰¾åˆ°é‚£ä¸ªæŒ‰é’®ï¼ŒæŠŠå®ƒå˜ç°ï¼Œæ˜¾ç¤ºâ€œæ­£åœ¨åˆ é™¤...â€
    // è¿™æ ·ç”¨æˆ·å°±ä¼šæ„Ÿè§‰åˆ°â€œç½‘é¡µå·²ç»åœ¨å¹²æ´»äº†â€
    const btn = event.target; // è·å–å½“å‰ç‚¹å‡»çš„é‚£ä¸ªæŒ‰é’®
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerText = 'å¤„ç†ä¸­...';
  
    try {
      // 3. æ‰§è¡Œåˆ é™¤ (è¿™é‡Œå…¶å®åªéœ€è¦åˆ  usersï¼Œå› ä¸ºä¸Šé¢ SQL è®¾ç½®äº† cascadeï¼Œè®°å½•ä¼šè‡ªåŠ¨æ¶ˆå¤±)
      const { error } = await supabaseClient
        .from('users')
        .delete()
        .eq('id', uid);
  
      if (error) throw error;
  
      // 4. æˆåŠŸåï¼šä¸è¦ç­‰é‡æ–°åŠ è½½ï¼Œç›´æ¥ä»ç½‘é¡µä¸ŠæŠŠè¿™ä¸€è¡Œâ€œæ»‘æ‰â€
      // è¿™æ ·ç»™äººçš„æ„Ÿè§‰å°±æ˜¯â€œç§’åˆ â€
      btn.parentElement.style.transition = '0.3s';
      btn.parentElement.style.opacity = '0';
      setTimeout(() => {
        btn.parentElement.remove(); // 0.3ç§’åä»ç½‘é¡µå½»åº•ç§»é™¤
        alert(`ç”¨æˆ· ${uname} å·²åˆ é™¤`);
      }, 300);
  
    } catch (err) {
      console.error(err);
      alert('åˆ é™¤å¤±è´¥ï¼ŒåŸå› ï¼š' + err.message);
      btn.disabled = false;
      btn.innerText = originalText;
    }
  }

  async function doCheckIn() {
    const { error } = await supabaseClient.from('records').insert([{ user_id: currentUser.id, category: document.getElementById('categorySelect').value }]);
    if (error) alert(error.code === '23505' ? 'å·²æ‰“å¡' : error.message);
    else { alert('æ‰“å¡æˆåŠŸ'); loadAllData(); }
  }

  function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
    document.getElementById('page-' + pageId).classList.remove('hidden');
    if(document.getElementById('nav-' + pageId)) document.getElementById('nav-' + pageId).classList.add('active');
    if(pageId === 'admin') loadAdminUserList();
  }

  function logout() { localStorage.clear(); location.reload(); }

  const savedUser = localStorage.getItem('qifei_user');
  if (savedUser) { currentUser = JSON.parse(savedUser); initApp(); }
  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('checkInBtn').addEventListener('click', doCheckIn);
</script>

</body>
</html>
