<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èµ·é£æ‰“å¡ä¼åˆ’ </title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --primary: #007bff; --bg: #f4f7f6; --success: #28a745; --gold: #ffd700; }
    body { font-family: system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
    .container { max-width: 500px; margin: 0 auto; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }
    h1, h2, h3 { margin-top: 0; text-align: center; }
    input, select, button { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
    button:disabled { background: #ccc; }

    /* å¯¼èˆª */
    .nav { display: flex; gap: 5px; margin-bottom: 15px; }
    .nav button { flex: 1; background: #eee; color: #666; font-size: 13px; padding: 10px 5px; }
    .nav button.active { background: var(--primary); color: white; }

    /* åˆ†ç±»è¿‡æ»¤å™¨ */
    .filter-bar { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
    .filter-bar span { padding: 6px 15px; background: #fff; border: 1px solid #ddd; border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; }
    .filter-bar span.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* æ’è¡Œæ¦œ */
    .rank-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
    .rank-item:hover { background: #f0f7ff; }

    /* æ—¥å†ç½‘æ ¼ */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
    .cal-day { aspect-ratio: 1/1; background: #eee; border-radius: 4px; font-size: 10px; display: flex; align-items: center; justify-content: center; color: #999; position: relative; }
    .cal-day.active { background: var(--success); color: white; font-weight: bold; }
    .cal-day.active::after { content: ''; width: 4px; height: 4px; background: white; border-radius: 50%; position: absolute; bottom: 3px; }

    /* å†å²æœˆä»½é€‰æ‹©å™¨ */
    .month-picker { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; }
    .month-chip { padding: 8px 12px; background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; font-size: 12px; cursor: pointer; white-space: nowrap; text-align: center; }
    .month-chip.active { border-color: var(--primary); color: var(--primary); background: #e7f1ff; }

    .record-item { display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 5px; font-size: 13px; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="container">
  <div id="loginSection" class="card">
    <h1>ğŸš€ èµ·é£æ‰“å¡</h1>
    <input id="username" placeholder="è´¦å·" />
    <input id="password" type="password" placeholder="å¯†ç " />
    <input id="nickname" placeholder="æ˜µç§° (ä»…æ³¨å†Œ)" />
    <button id="loginBtn">ç™»å½• / æ³¨å†Œ</button>
  </div>

  <div id="mainSection" class="hidden">
    <div class="nav">
      <button onclick="showPage('checkin')" id="nav-checkin" class="active">æ‰“å¡</button>
      <button onclick="showPage('rank')" id="nav-rank">æ¦œå•</button>
      <button onclick="showPage('me')" id="nav-me">æˆå°±</button>
      <button onclick="showPage('admin')" id="nav-admin" class="hidden">ç®¡ç†</button>
    </div>

    <!-- æ‰“å¡é¡µ -->
    <div id="page-checkin" class="page card">
      <h2>æ—©å®‰, <span id="displayNickname"></span></h2>
      <select id="categorySelect">
        <option value="çœŸäºº">ä¸‰æ¬¡å…ƒ ğŸ¬</option>
        <option value="æœ¬å­">æœ¬å­ ğŸ“–</option>
        <option value="é¬¼è„‘">é¬¼è„‘ ğŸ§ </option>
      </select>
      <input type="date" id="checkInDate">
      <button id="checkInBtn" style="margin-top:20px;">ç¡®è®¤æ‰“å¡ ğŸš€</button>
      <div id="annoBox" style="margin-top:15px; font-size:12px; color:#999;"></div>
    </div>

    <!-- æ¦œå•é¡µ -->
    <div id="page-rank" class="page card hidden">
      <h3>é£è¡Œæ’è¡Œæ¦œ</h3>
      <div class="filter-bar" id="rankFilter">
        <span class="active" onclick="changeRankType('Total', this)">æ€»æ¦œå•</span>
        <span onclick="changeRankType('çœŸäºº', this)">ä¸‰æ¬¡å…ƒæ¦œ</span>
        <span onclick="changeRankType('æœ¬å­', this)">æœ¬å­æ¦œ</span>
        <span onclick="changeRankType('é¬¼è„‘''é¬¼è„‘''n'">é¬¼è„‘æ¦œ</span>
      </div>
      <div id="rankList"></div>
    </div>

    <!-- è¯¦æƒ…é¡µ -->
    <div id="page-profile" class="page card hidden">
      <button onclick="showPage('rank')" style="background:#666; width:70px; font-size:12px; margin-bottom:10px;">â† è¿”å›</button>
      <h2 id="profName">ç”¨æˆ·æ—¥å¿—</h2>
      
      <div id="profStats" style="background:#f0f7ff; padding:15px; border-radius:10px; margin-bottom:15px; font-size:14px;">
        <div style="display:flex; justify-content:space-between;"><span>ç´¯è®¡æ€»æ¬¡æ•°ï¼š</span><b id="profTotalCount">0</b></div>
        <div id="profCatBreakdown" style="margin-top:5px; color:#555; font-size:12px;"></div>
      </div>

      <h4 id="calTitle">æœˆä»½åˆ†å¸ƒ</h4>
      <div id="calendar" class="calendar-grid"></div>

      <h4>é€‰æ‹©æœˆä»½</h4>
      <div id="monthPicker" class="month-picker"></div>

      <h4 style="margin-top:20px;">è®°å½•æ˜ç»†</h4>
      <div id="detailList"></div>
    </div>

    <!-- æˆå°±/ç®¡ç† -->
    <div id="page-me" class="page card hidden"><div id="achievementsBox"></div><button onclick="logout()" style="background:#666; margin-top:20px;">é€€å‡ºç™»å½•</button></div>
    <div id="page-admin" class="page card hidden"><div id="adminUserList"></div></div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://bunogkfayqafxghedrdt.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_9zBGizofsJmjERXnN68epQ_L-cGXu2F';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUser = null;
  let viewingRecords = [];
  let currentRankCategory = 'Total';

  // 1. ç™»å½•æ³¨å†Œ
  async function login() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    const n = document.getElementById('nickname').value.trim();
    if(!u || !p) return alert('è¯·å¡«å…¨è´¦å·å¯†ç ');
    
    let { data: user } = await supabaseClient.from('users').select('*').eq('username', u).maybeSingle();
    if(!user) {
      if(!n) return alert('æ–°ç”¨æˆ·è¯·å¡«æ˜µç§°');
      const { data: nu, error } = await supabaseClient.from('users').insert([{username:u, password:p, nickname:n}]).select().single();
      if(error) return alert(error.message);
      user = nu;
    } else if(user.password !== p) return alert('å¯†ç é”™è¯¯');

    currentUser = user;
    localStorage.setItem('qifei_user', JSON.stringify(user));
    initApp();
  }

  function initApp() {
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('mainSection').classList.remove('hidden');
    document.getElementById('displayNickname').innerText = currentUser.nickname;
    document.getElementById('checkInDate').value = new Date().toISOString().split('T')[0];
    if(currentUser.role === 'admin') document.getElementById('nav-admin').classList.remove('hidden');
    loadRank();
    loadAllData();
  }

  // 2. åˆ†ç±»æ¦œå•é€»è¾‘
  function changeRankType(cat, el) {
    currentRankCategory = cat;
    document.querySelectorAll('#rankFilter span').forEach(s => s.classList.remove('active'));
    el.classList.add('active');
    loadRank();
  }

  async function loadRank() {
    let query = supabaseClient.from('records').select('user_id, category, users(nickname)');
    if(currentRankCategory !== 'Total') query = query.eq('category', currentRankCategory);
    
    const { data } = await query;
    const stats = {};
    data.forEach(r => {
      const id = r.user_id;
      if(!stats[id]) stats[id] = { name: r.users?.nickname || 'æœªçŸ¥', count: 0 };
      stats[id].count++;
    });
    const sorted = Object.entries(stats).sort((a,b) => b[1].count - a[1].count);
    document.getElementById('rankList').innerHTML = sorted.map(([id, info], i) => `
      <div class="rank-item" onclick="viewUserProfile('${id}', '${info.name}')">
        <span>${i+1}. ${info.name}</span>
        <strong>${info.count} æ¬¡ ></strong>
      </div>
    `).join('') || '<p style="text-align:center; color:#999; margin-top:20px;">æš‚æ— æ•°æ®</p>';
  }

  // 3. ä¸ªäººæ·±åº¦èµ„æ–™ä¸å†å²æœˆä»½åˆ‡æ¢
  async function viewUserProfile(uid, uname) {
    showPage('profile');
    document.getElementById('profName').innerText = uname + ' çš„é£è¡Œæ¡£æ¡ˆ';
    
    const { data: records } = await supabaseClient.from('records').select('*').eq('user_id', uid).order('checkin_date', {ascending: false});
    viewingRecords = records || [];

    // ç»Ÿè®¡å„ç±»åˆ«æ€»è®¡
    const cats = {};
    viewingRecords.forEach(r => cats[r.category] = (cats[r.category] || 0) + 1);
    document.getElementById('profTotalCount').innerText = viewingRecords.length;
    document.getElementById('profCatBreakdown').innerHTML = Object.entries(cats).map(([k,v]) => `${k}: ${v}`).join(' | ');

    // æå–æ‰€æœ‰æœˆä»½
    const monthSet = new Set(viewingRecords.map(r => r.checkin_date.slice(0, 7)));
    const months = Array.from(monthSet).sort().reverse();

    // æ¸²æŸ“æœˆä»½é€‰æ‹©å™¨
    document.getElementById('monthPicker').innerHTML = months.map(m => `
      <div class="month-chip" id="chip-${m}" onclick="renderMonthView('${m}', '${uid}')">${m.replace('-','å¹´')}æœˆ</div>
    `).join('');

    // é»˜è®¤æ¸²æŸ“æœ€æ–°æœˆä»½
    if(months.length) renderMonthView(months[0], uid);
  }

  function renderMonthView(mStr, uid) {
    document.querySelectorAll('.month-chip').forEach(c => c.classList.remove('active'));
    document.getElementById('chip-'+mStr)?.classList.add('active');
    document.getElementById('calTitle').innerText = mStr.replace('-','å¹´') + 'æœˆ æ‰“å¡åˆ†å¸ƒ';

    const monthRecs = viewingRecords.filter(r => r.checkin_date.startsWith(mStr));
    const daySet = new Set(monthRecs.map(r => parseInt(r.checkin_date.slice(8,10))));
    
    // æ¸²æŸ“æ—¥å†ç½‘æ ¼
    const [y, m] = mStr.split('-').map(Number);
    const days = new Date(y, m, 0).getDate();
    let calHtml = '';
    for(let i=1; i<=days; i++) {
      calHtml += `<div class="cal-day ${daySet.has(i)?'active':''}">${i}</div>`;
    }
    document.getElementById('calendar').innerHTML = calHtml;

    // æ¸²æŸ“æ˜ç»†
    document.getElementById('detailList').innerHTML = monthRecs.map(r => `
      <div class="record-item">
        <span>${r.checkin_date} [${r.category}]</span>
        ${uid === currentUser.id ? `<button onclick="delRec('${r.id}', event)" style="width:auto; padding:2px 8px; background:none; border:1px solid red; color:red; font-size:11px; margin:0;">åˆ é™¤</button>` : ''}
      </div>
    `).join('');
  }

  // 4. æ‰“å¡ä¸åˆ é™¤
  async function doCheckIn() {
    const c = document.getElementById('categorySelect').value;
    const d = document.getElementById('checkInDate').value;
    const { error } = await supabaseClient.from('records').insert([{ user_id: currentUser.id, category: c, checkin_date: d }]);
    if(error) alert('æ‰“å¡å¤±è´¥: ' + error.message);
    else { alert('æ‰“å¡æˆåŠŸï¼'); loadAllData(); loadRank(); }
  }

  async function delRec(rid, e) {
    if(!confirm('åˆ é™¤è®°å½•ï¼Ÿ')) return;
    const { error } = await supabaseClient.from('records').delete().eq('id', rid);
    if(!error) { e.target.closest('.record-item').remove(); loadAllData(); loadRank(); }
  }

  // å…¶ä»–åŸºç¡€åŠŸèƒ½
  function showPage(p) {
    document.querySelectorAll('.page').forEach(x => x.classList.add('hidden'));
    document.querySelectorAll('.nav button').forEach(x => x.classList.remove('active'));
    document.getElementById('page-'+p).classList.remove('hidden');
    if(document.getElementById('nav-'+p)) document.getElementById('nav-'+p).classList.add('active');
  }

  async function loadAllData() {
    if(!currentUser) return;
    const { data: annos } = await supabaseClient.from('announcements').select('content').limit(1);
    document.getElementById('annoBox').innerText = "ğŸ“¢ å…¬å‘Šï¼š" + (annos?.[0]?.content || "æš‚æ— å…¬å‘Š");
    
    const { data: r } = await supabaseClient.from('records').select('id').eq('user_id', currentUser.id);
    const count = r?.length || 0;
    const { data: achs } = await supabaseClient.from('achievements').select('*').order('threshold', {ascending:true});
    const { data: earned } = await supabaseClient.from('user_achievements').select('achievement_id').eq('user_id', currentUser.id);
    const eIds = earned?.map(e => e.achievement_id) || [];
    
    document.getElementById('achievementsBox').innerHTML = '<h3>æˆ‘çš„æˆå°±</h3>' + achs.map(a => `
      <div style="display:flex; align-items:center; padding:10px; border:1px solid #eee; border-radius:8px; margin-bottom:8px; opacity:${eIds.includes(a.id)?1:0.4}; background:${eIds.includes(a.id)?'#fffde7':'#fafafa'}">
        <span style="font-size:20px; margin-right:10px;">${eIds.includes(a.id)?'ğŸ†':'ğŸ”’'}</span>
        <div><strong>${a.title}</strong><br><small>${a.description} (${count}/${a.threshold})</small></div>
      </div>`).join('');
  }

  function logout() { localStorage.clear(); location.reload(); }
  const savedUser = localStorage.getItem('qifei_user');
  if (savedUser) { currentUser = JSON.parse(savedUser); initApp(); }
  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('checkInBtn').addEventListener('click', doCheckIn);
</script>
</body>
</html>
