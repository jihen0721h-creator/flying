<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å†³æˆ˜é£æœºä¹‹å·…</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --primary: #007bff; --bg: #f4f7f6; --success: #28a745; --gold: #ffd700; }
    body { font-family: system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
    .container { max-width: 500px; margin: 0 auto; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }
    h1, h2, h3 { margin-top: 0; text-align: center; }
    input, select, button, textarea { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    textarea { height: 70px; resize: none; }
    button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
    button:disabled { background: #ccc; }

    .nav { display: flex; gap: 5px; margin-bottom: 15px; }
    .nav button { flex: 1; background: #eee; color: #666; font-size: 13px; padding: 10px 5px; }
    .nav button.active { background: var(--primary); color: white; }

    .filter-bar { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
    .filter-bar span { padding: 6px 15px; background: #fff; border: 1px solid #ddd; border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; }
    .filter-bar span.active { background: var(--primary); color: white; border-color: var(--primary); }

    .rank-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
    .cat-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .cat-stat-box { background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 4px solid var(--primary); }
    .cat-stat-box small { color: #666; font-size: 11px; }
    .cat-stat-box b { display: block; font-size: 18px; color: var(--primary); }

    .record-item { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 8px; font-size: 13px; }
    .record-note { margin-top: 5px; color: #555; background: #fff; padding: 6px; border-radius: 4px; border-left: 3px solid #ddd; font-style: italic; }

    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
    .cal-day { aspect-ratio: 1/1; background: #eee; border-radius: 4px; font-size: 10px; display: flex; align-items: center; justify-content: center; color: #999; }
    .cal-day.active { background: var(--success); color: white; font-weight: bold; }

    .month-picker { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; }
    .month-chip { padding: 8px 12px; background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; font-size: 12px; cursor: pointer; white-space: nowrap; text-align: center; }
    .month-chip.active { border-color: var(--primary); color: var(--primary); background: #e7f1ff; }

    .hidden { display: none !important; }
    label { font-size: 12px; color: #666; font-weight: bold; margin-top: 12px; display: block; }
  </style>
</head>
<body>

<div class="container">
  <div id="loginSection" class="card">
    <h1>ğŸš€ èµ·é£æ‰“å¡</h1>
    <input id="username" placeholder="è´¦å·" />
    <input id="password" type="password" placeholder="å¯†ç " />
    <input id="nickname" placeholder="æ˜µç§° (ä»…æ³¨å†Œ)" />
    <button id="loginBtn">ç™»å½• / æ³¨å†Œ</button>
  </div>

  <div id="mainSection" class="hidden">
    <div class="nav">
      <button onclick="showPage('checkin')" id="nav-checkin" class="active">æ‰“å¡</button>
      <button onclick="showPage('rank')" id="nav-rank">æ¦œå•</button>
      <button onclick="showPage('me')" id="nav-me">æˆå°±</button>
      <button onclick="showPage('admin')" id="nav-admin" class="hidden">ç®¡ç†</button>
    </div>

    <div id="page-checkin" class="page card">
      <h2>æ—©å®‰, <span id="displayNickname"></span></h2>
      <label>åˆ†ç±»</label>
      <select id="categorySelect">
        <option value="ä¸‰æ¬¡å…ƒ">ä¸‰æ¬¡å…ƒ</option>
        <option value="æœ¬å­">æœ¬å­</option>
        <option value="å†»é³—">å†»é³—</option>
        <option value="é¬¼è„‘">é¬¼è„‘</option>
      </select>
      <label>èµ·é£æ—¶é—´</label>
      <input type="datetime-local" id="checkInDate">
      <label>èµ·é£æ„Ÿè°¢ (å¤‡æ³¨)</label>
      <textarea id="checkInNote" placeholder="è¾“å…¥æ„Ÿæƒ³..."></textarea>
      <button id="checkInBtn" style="margin-top:15px;">ç¡®è®¤èµ·é£ ğŸš€</button>
      <div id="annoBox" style="margin-top:10px; font-size:12px; color:#999;"></div>
    </div>

    <div id="page-rank" class="page card hidden">
      <h3>é£è¡Œæ’è¡Œæ¦œ</h3>
      <div class="filter-bar" id="rankFilter">
        <span class="active" onclick="changeRankCat('Total', this)">æ€»æ¦œ</span>
        <span onclick="changeRankCat('ä¸‰æ¬¡å…ƒ', this)">ä¸‰æ¬¡å…ƒ</span>
        <span onclick="changeRankCat('æœ¬å­', this)">æœ¬å­</span>
        <span onclick="changeRankCat('å†»é³—', this)">å†»é³—</span>
        <span onclick="changeRankCat('é¬¼è„‘', this)">é¬¼è„‘</span>
      </div>
      <div id="rankList"></div>
    </div>

    <div id="page-profile" class="page card hidden">
      <button onclick="showPage('rank')" style="background:#666; width:60px; font-size:11px;">â† è¿”å›</button>
      <h2 id="profName">ç”¨æˆ·æ¡£æ¡ˆ</h2>
      <div id="profTotalCard" style="background:#e7f1ff; padding:15px; border-radius:10px;">
        <small>ç´¯è®¡é£è¡Œæ€»è®¡</small>
        <div style="font-size:32px; font-weight:bold; color:var(--primary);" id="profTotalCount">0</div>
      </div>
      <div class="cat-stats-grid" id="profCatGrid"></div>
      <h4 id="calTitle" style="margin-top:20px;">æ‰“å¡åˆ†å¸ƒ</h4>
      <div id="calendar" class="calendar-grid"></div>
      <div id="monthPicker" class="month-picker"></div>
      <h4>é£è¡Œæ˜ç»†</h4>
      <div id="detailList"></div>
    </div>

    <div id="page-me" class="page card hidden">
      <div id="achievementsBox"></div>
      <button onclick="logout()" style="background:#666; margin-top:20px;">é€€å‡ºç™»å½•</button>
    </div>

    <div id="page-admin" class="page card hidden">
      <div id="adminUserList"></div>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://bunogkfayqafxghedrdt.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_9zBGizofsJmjERXnN68epQ_L-cGXu2F';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUser = null;
  let viewingRecords = [];
  let currentRankCat = 'Total';

  function resetInput() {
    const now = new Date();
    now.setMinutes(0);
    const tzoffset = now.getTimezoneOffset() * 60000;
    document.getElementById('checkInDate').value = (new Date(now - tzoffset)).toISOString().slice(0, 16);
    document.getElementById('checkInNote').value = "";
  }

  async function login() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    const n = document.getElementById('nickname').value.trim();
    if(!u || !p) return alert('å¿…å¡«');
    try {
      let { data: user } = await supabaseClient.from('users').select('*').eq('username', u).maybeSingle();
      if(!user) {
        if(!n) return alert('æ–°ç”¨æˆ·è¯·å¡«æ˜µç§°');
        const { data: nu, error } = await supabaseClient.from('users').insert([{username:u, password:p, nickname:n}]).select().single();
        if(error) throw error;
        user = nu;
      } else if(user.password !== p) return alert('å¯†ç é”™è¯¯');
      currentUser = user;
      localStorage.setItem('qifei_user', JSON.stringify(user));
      initApp();
    } catch (e) { alert(e.message); }
  }

  function initApp() {
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('mainSection').classList.remove('hidden');
    document.getElementById('displayNickname').innerText = currentUser.nickname;
    if(currentUser.role === 'admin') document.getElementById('nav-admin').classList.remove('hidden');
    resetInput();
    loadRank();
    loadAllData();
  }

  function changeRankCat(cat, el) {
    currentRankCat = cat;
    document.querySelectorAll('#rankFilter span').forEach(s => s.classList.remove('active'));
    el.classList.add('active');
    loadRank();
  }

  async function loadRank() {
    let query = supabaseClient.from('records').select('user_id, category, users(nickname)');
    if(currentRankCat !== 'Total') query = query.eq('category', currentRankCat);
    const { data } = await query;
    const stats = {};
    data.forEach(r => {
      const id = r.user_id;
      if(!stats[id]) stats[id] = { name: r.users?.nickname || 'æœªçŸ¥', count: 0 };
      stats[id].count++;
    });
    const sorted = Object.entries(stats).sort((a,b) => b[1].count - a[1].count);
    document.getElementById('rankList').innerHTML = sorted.map(([id, info], i) => `
      <div class="rank-item" onclick="viewUserProfile('${id}', '${info.name}')">
        <span>${i+1}. ${info.name}</span><strong>${info.count} æ¬¡ ></strong>
      </div>`).join('') || '<p style="text-align:center;color:#999;margin-top:20px;">æš‚æ— æ•°æ®</p>';
  }

  async function viewUserProfile(uid, uname) {
    showPage('profile');
    document.getElementById('profName').innerText = uname;
    const { data: recs } = await supabaseClient.from('records').select('*').eq('user_id', uid).order('checkin_date', {ascending: false});
    viewingRecords = recs || [];
    const catCounts = { 'ä¸‰æ¬¡å…ƒ': 0, 'æœ¬å­': 0, 'å†»é³—': 0,'é¬¼è„‘': 0 };
    viewingRecords.forEach(r => { if(catCounts[r.category] !== undefined) catCounts[r.category]++; });
    document.getElementById('profTotalCount').innerText = viewingRecords.length;
    document.getElementById('profCatGrid').innerHTML = Object.entries(catCounts).map(([k,v]) => `
      <div class="cat-stat-box"><small>${k}</small><b>${v}</b></div>`).join('');
    const months = Array.from(new Set(viewingRecords.map(r => r.checkin_date.slice(0, 7)))).sort().reverse();
    document.getElementById('monthPicker').innerHTML = months.map(m => `
      <div class="month-chip" id="chip-${m}" onclick="renderMonthView('${m}', '${uid}')">${m}</div>`).join('');
    if(months.length) renderMonthView(months[0], uid);
  }

  function renderMonthView(mStr, uid) {
    document.querySelectorAll('.month-chip').forEach(c => c.classList.remove('active'));
    document.getElementById('chip-'+mStr)?.classList.add('active');
    const monthRecs = viewingRecords.filter(r => r.checkin_date.startsWith(mStr));
    const daySet = new Set(monthRecs.map(r => parseInt(r.checkin_date.slice(8,10))));
    const [y, m] = mStr.split('-').map(Number);
    const days = new Date(y, m, 0).getDate();
    let calHtml = '';
    for(let i=1; i<=days; i++) calHtml += `<div class="cal-day ${daySet.has(i)?'active':''}">${i}</div>`;
    document.getElementById('calendar').innerHTML = calHtml;
    document.getElementById('detailList').innerHTML = monthRecs.map(r => `
      <div class="record-item">
        <b>${r.checkin_date.replace('T',' ').slice(0,16)}</b> [${r.category}]
        ${r.notes ? `<div class="record-note">èµ·é£æ„Ÿè°¢ï¼š${r.notes}</div>` : ''}
        ${uid === currentUser.id ? `<button onclick="delRec('${r.id}', event)" style="width:auto;padding:2px 8px;background:none;border:1px solid red;color:red;font-size:11px;margin:0;">åˆ é™¤</button>` : ''}
      </div>`).join('');
  }

  async function doCheckIn() {
    const c = document.getElementById('categorySelect').value;
    const d = document.getElementById('checkInDate').value;
    const n = document.getElementById('checkInNote').value.trim();
    const btn = document.getElementById('checkInBtn');
    btn.disabled = true;
    const { error } = await supabaseClient.from('records').insert([{ user_id: currentUser.id, category: c, checkin_date: d, notes: n }]);
    if(!error) { alert('èµ·é£æˆåŠŸï¼'); resetInput(); loadRank(); loadAllData(); }
    else alert(error.message);
    btn.disabled = false;
  }

  async function delRec(rid, e) {
    if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
    await supabaseClient.from('records').delete().eq('id', rid);
    e.target.closest('.record-item').remove();
    loadRank();
  }

  // --- è¡¥å…¨ç®¡ç†é¡µé¢å‡½æ•° ---
  async function loadAdminUserList() {
    const { data: users, error } = await supabaseClient.from('users').select('*').order('created_at', {ascending: false});
    if(error) return alert(error.message);
    document.getElementById('adminUserList').innerHTML = '<h3>ç”¨æˆ·ç®¡ç†</h3>' + users.map(u => `
      <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #eee;">
        <div><strong>${u.nickname}</strong><br><small>è´¦å·: ${u.username}</small></div>
        ${u.role !== 'admin' ? `<button onclick="deleteUser('${u.id}', '${u.nickname}', event)" style="width:auto; background:red; padding:6px 12px; font-size:12px;">åˆ é™¤</button>` : '<span>ç®¡ç†å‘˜</span>'}
      </div>`).join('');
  }

  async function deleteUser(uid, uname, event) {
    if(!confirm(`ç¡®å®šåˆ é™¤ç”¨æˆ· ${uname}ï¼Ÿ`)) return;
    const btn = event.target;
    const row = btn.closest('div').parentElement;
    btn.disabled = true;
    const { error } = await supabaseClient.from('users').delete().eq('id', uid);
    if(error) { alert(error.message); btn.disabled = false; }
    else { row.remove(); }
  }

  async function loadAllData() {
    if(!currentUser) return;
    const { data: annos } = await supabaseClient.from('announcements').select('content').limit(1);
    document.getElementById('annoBox').innerText = "ğŸ“¢ å…¬å‘Šï¼š" + (annos?.[0]?.content || "æš‚æ— å…¬å‘Š");
    
    const { data: r } = await supabaseClient.from('records').select('id').eq('user_id', currentUser.id);
    const count = r?.length || 0;
    const { data: achs } = await supabaseClient.from('achievements').select('*').order('threshold', {ascending:true});
    const { data: earned } = await supabaseClient.from('user_achievements').select('achievement_id').eq('user_id', currentUser.id);
    const eIds = earned?.map(e => e.achievement_id) || [];
    
    document.getElementById('achievementsBox').innerHTML = '<h3>æˆ‘çš„æˆå°±</h3>' + achs.map(a => {
      const isEarned = eIds.includes(a.id);
      return `
      <div style="display:flex; align-items:center; padding:10px; border:1px solid #eee; border-radius:8px; margin-bottom:8px; opacity:${isEarned?1:0.4}; background:${isEarned?'#fffde7':'#fafafa'}">
        <span style="font-size:20px; margin-right:10px;">${isEarned?'ğŸ†':'ğŸ”’'}</span>
        <div><strong>${a.title}</strong><br><small>${a.description} (${count}/${a.threshold})</small></div>
      </div>`}).join('');
  }

  function showPage(p) {
    document.querySelectorAll('.page').forEach(x => x.classList.add('hidden'));
    document.querySelectorAll('.nav button').forEach(x => x.classList.remove('active'));
    document.getElementById('page-'+p).classList.remove('hidden');
    if(document.getElementById('nav-'+p)) document.getElementById('nav-'+p).classList.add('active');
    if(p === 'admin') loadAdminUserList(); // è§¦å‘åŠ è½½
  }

  function logout() { localStorage.clear(); location.reload(); }
  const savedUser = localStorage.getItem('qifei_user');
  if (savedUser) { currentUser = JSON.parse(savedUser); initApp(); }
  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('checkInBtn').addEventListener('click', doCheckIn);
</script>
</body>
</html>
