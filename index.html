<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èµ·é£æ‰“å¡ä¼åˆ’ Â· è®°å½•ç®¡ç†ç‰ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --primary: #007bff; --bg: #f4f7f6; --success: #28a745; --gold: #ffd700; --danger: #dc3545; }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; }
    .container { max-width: 500px; margin: 0 auto; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }
    h1, h2, h3 { margin-top: 0; text-align: center; }
    input, select, button { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    
    .nav { display: flex; gap: 5px; margin-bottom: 15px; }
    .nav button { flex: 1; background: #eee; color: #666; font-size: 13px; padding: 10px 5px; }
    .nav button.active { background: var(--primary); color: white; }

    .rank-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
    
    /* ç»Ÿè®¡é¡µå¢å¼º */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 10px; }
    .cal-day { aspect-ratio: 1/1; background: #eee; border-radius: 4px; font-size: 10px; display: flex; align-items: center; justify-content: center; color: #999; }
    .cal-day.active { background: var(--success); color: white; font-weight: bold; }

    /* è®°å½•æ˜ç»†åˆ—è¡¨ */
    .record-detail-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; font-size: 13px; }
    .del-rec-btn { background: none; color: var(--danger); border: 1px solid var(--danger); width: auto; padding: 2px 8px; font-size: 11px; margin-top: 0; }
    .del-rec-btn:hover { background: var(--danger); color: white; }

    .achievement-item { display: flex; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; font-size: 14px; }
    .achievement-item.unlocked { background: #fffde7; border-color: var(--gold); }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="container">
  <!-- ç™»å½•æ¡† -->
  <div id="loginSection" class="card">
    <h1>ğŸš€ èµ·é£æ‰“å¡</h1>
    <input id="username" placeholder="è´¦å·" />
    <input id="password" type="password" placeholder="å¯†ç " />
    <input id="nickname" placeholder="æ˜µç§° (ä»…æ³¨å†Œéœ€å¡«)" />
    <button id="loginBtn">ç™»å½•/è¿›å…¥ä¼åˆ’</button>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="mainSection" class="hidden">
    <div class="nav">
      <button onclick="showPage('checkin')" id="nav-checkin" class="active">æ‰“å¡</button>
      <button onclick="showPage('rank')" id="nav-rank">æ¦œå•</button>
      <button onclick="showPage('me')" id="nav-me">æˆå°±</button>
      <button onclick="showPage('admin')" id="nav-admin" class="hidden">ç®¡ç†</button>
    </div>

    <!-- æ‰“å¡é¡µ -->
    <div id="page-checkin" class="page card">
      <h2 style="font-size: 18px;">ä½ å¥½, <span id="displayNickname"></span></h2>
      <select id="categorySelect">
        <option value="çœŸäºº">çœŸäººç´ æ ğŸ¬</option>
        <option value="æœ¬å­">çº¸è´¨æœ¬å­ ğŸ“–</option>
        <option value="è§†é¢‘">çŸ­è§†é¢‘ ğŸ“±</option>
      </select>
      <input type="date" id="checkInDate">
      <button id="checkInBtn" style="margin-top:20px;">ç¡®è®¤æ‰“å¡ ğŸš€</button>
      <div id="annoBox" style="margin-top:20px; font-size:12px; color:#888;"></div>
    </div>

    <!-- èµ„æ–™è¯¦æƒ…é¡µ -->
    <div id="page-profile" class="page card hidden">
      <button onclick="showPage('rank')" style="background:#666; width:70px; font-size:12px; margin-bottom:10px;">â† è¿”å›</button>
      <h2 id="profName" style="font-size: 18px;">èµ„æ–™è¯¦æƒ…</h2>
      
      <!-- æ±‡æ€» -->
      <div id="profSummary" style="background:#e7f1ff; padding:15px; border-radius:10px; margin-bottom:15px;">
        <strong>ç´¯è®¡èµ·é£ï¼š<span id="profTotalCount">0</span> æ¬¡</strong>
        <div id="profCategoryStats" style="font-size:12px; margin-top:5px; color:#555;"></div>
      </div>

      <h4 id="calendarTitle">æœˆä»½åˆ†å¸ƒ</h4>
      <div id="calendar" class="calendar-grid"></div>

      <h4 style="margin-top:20px;">æ‰“å¡æ˜ç»†</h4>
      <div id="recordList"></div>
    </div>

    <!-- æ¦œå•é¡µ -->
    <div id="page-rank" class="page card hidden">
      <h3>æ’è¡Œæ¦œ (ç‚¹å‡»å¤´åƒæŸ¥çœ‹)</h3>
      <div id="rankList"></div>
    </div>

    <!-- æˆå°±é¡µ -->
    <div id="page-me" class="page card hidden">
      <h2>æˆå°±å¢™</h2>
      <div id="achievementsBox"></div>
      <button onclick="logout()" style="background:#666; margin-top:20px; font-size:12px;">é€€å‡ºç™»å½•</button>
    </div>

    <!-- ç®¡ç†é¡µ -->
    <div id="page-admin" class="page card hidden">
      <h2>ç®¡ç†ä¸­å¿ƒ</h2>
      <div id="adminUserList"></div>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://bunogkfayqafxghedrdt.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_9zBGizofsJmjERXnN68epQ_L-cGXu2F';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUser = null;
  let viewingUserId = null;

  // 1. ç™»å½•
  async function login() {
    const userVal = document.getElementById('username').value.trim();
    const passVal = document.getElementById('password').value.trim();
    const nickVal = document.getElementById('nickname').value.trim();
    if (!userVal || !passVal) return alert('å¿…å¡«');
    try {
      let { data: user } = await supabaseClient.from('users').select('*').eq('username', userVal).maybeSingle();
      if (!user) {
        if (!nickVal) return alert('æ–°ç”¨æˆ·éœ€å¡«æ˜µç§°');
        const { data: nu, error: e } = await supabaseClient.from('users').insert([{username: userVal, password: passVal, nickname: nickVal}]).select().single();
        if(e) throw e; user = nu;
      } else if (user.password !== passVal) return alert('å¯†ç é”™è¯¯');
      currentUser = user;
      localStorage.setItem('qifei_user', JSON.stringify(user));
      initApp();
    } catch(e){ alert(e.message); }
  }

  function initApp() {
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('mainSection').classList.remove('hidden');
    document.getElementById('displayNickname').innerText = currentUser.nickname;
    document.getElementById('checkInDate').value = new Date().toISOString().split('T')[0];
    if (currentUser.role === 'admin') document.getElementById('nav-admin').classList.remove('hidden');
    loadRank();
    loadAllData();
  }

  // 2. æ‰“å¡é€»è¾‘ (æ”¯æŒå¤šæ¬¡)
  async function doCheckIn() {
    const category = document.getElementById('categorySelect').value;
    const date = document.getElementById('checkInDate').value;
    const btn = document.getElementById('checkInBtn');
    btn.disabled = true;
    const { error } = await supabaseClient.from('records').insert([{ user_id: currentUser.id, category, checkin_date: date }]);
    if (error) alert(error.message);
    else { alert('èµ·é£æˆåŠŸï¼'); loadAllData(); loadRank(); }
    btn.disabled = false;
  }

  // 3. æŸ¥çœ‹è¯¦æƒ… (æ”¯æŒåˆ é™¤å•æ¡è®°å½•)
  async function viewUserProfile(uid, uname) {
    viewingUserId = uid;
    showPage('profile');
    document.getElementById('profName').innerText = uname + ' çš„æ—¥å¿—';
    
    // è·å–è¯¥ç”¨æˆ·æ‰€æœ‰è®°å½•
    const { data: records } = await supabaseClient.from('records')
      .select('*').eq('user_id', uid).order('checkin_date', {ascending: false});
    
    // æ±‡æ€»æ•°æ®
    document.getElementById('profTotalCount').innerText = records.length;
    const cats = {};
    records.forEach(r => cats[r.category] = (cats[r.category] || 0) + 1);
    document.getElementById('profCategoryStats').innerText = Object.entries(cats).map(([k,v]) => `${k}:${v}`).join(' | ');

    // æ¸²æŸ“æ˜ç»†åˆ—è¡¨ (å¦‚æœæ˜¯è‡ªå·±çš„ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‰é’®)
    const listHtml = records.map(r => `
      <div class="record-detail-item">
        <span><b>${r.checkin_date}</b> [${r.category}]</span>
        ${uid === currentUser.id ? `<button class="del-rec-btn" onclick="deleteSingleRecord('${r.id}', event)">åˆ é™¤</button>` : ''}
      </div>
    `).join('');
    document.getElementById('recordList').innerHTML = listHtml || 'æš‚æ— æ•°æ®';

    // ç®€æ˜“æ—¥å† (æ˜¾ç¤ºå½“æœˆ)
    const thisMonth = new Date().toISOString().slice(0, 7);
    const daySet = new Set(records.filter(r => r.checkin_date.startsWith(thisMonth)).map(r => parseInt(r.checkin_date.slice(8,10))));
    const days = new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate();
    let calHtml = '';
    for(let i=1; i<=days; i++) calHtml += `<div class="cal-day ${daySet.has(i)?'active':''}">${i}</div>`;
    document.getElementById('calendar').innerHTML = calHtml;
    document.getElementById('calendarTitle').innerText = thisMonth + ' åˆ†å¸ƒ';
  }

  // åˆ é™¤å•æ¡æ‰“å¡è®°å½•
  async function deleteSingleRecord(rid, event) {
    if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿ')) return;
    const btn = event.target;
    btn.disabled = true;
    const { error } = await supabaseClient.from('records').delete().eq('id', rid);
    if(error) alert(error.message);
    else {
      btn.closest('.record-detail-item').remove();
      // åˆ·æ–°å…¶ä»–ç»Ÿè®¡
      const total = document.getElementById('profTotalCount');
      total.innerText = parseInt(total.innerText) - 1;
      loadAllData(); // åˆ·æ–°æˆå°±
      loadRank();    // åˆ·æ–°æ’è¡Œ
    }
  }

  // 4. å…¶ä»–é€»è¾‘
  async function loadRank() {
    const { data: raw } = await supabaseClient.from('records').select('user_id, users(nickname)');
    const stats = {};
    raw.forEach(r => {
      const id = r.user_id;
      if(!stats[id]) stats[id] = { name: r.users?.nickname || 'æœªçŸ¥', count: 0 };
      stats[id].count++;
    });
    const sorted = Object.entries(stats).sort((a,b) => b[1].count - a[1].count);
    document.getElementById('rankList').innerHTML = sorted.map(([id, info], i) => `
      <div class="rank-item" onclick="viewUserProfile('${id}', '${info.name}')">
        <span>${i+1}. ${info.name}</span>
        <strong>${info.count}æ¬¡</strong>
      </div>
    `).join('');
  }

  async function loadAllData() {
    if (!currentUser) return;
    const { data: recs } = await supabaseClient.from('records').select('id').eq('user_id', currentUser.id);
    const count = recs?.length || 0;
    const { data: achs } = await supabaseClient.from('achievements').select('*').order('threshold', {ascending:true});
    const { data: earned } = await supabaseClient.from('user_achievements').select('achievement_id').eq('user_id', currentUser.id);
    const earnedIds = earned?.map(e => e.achievement_id) || [];
    document.getElementById('achievementsBox').innerHTML = achs.map(a => {
      const isUn = earnedIds.includes(a.id);
      return `<div class="achievement-item ${isUn?'unlocked':''}">
        <div style="font-size:18px; margin-right:10px;">${isUn?'ğŸ†':'ğŸ”’'}</div>
        <div><strong>${a.title}</strong><br><small>${a.description} (${count}/${a.threshold})</small></div>
      </div>`;
    }).join('');
  }

  function showPage(p) {
    document.querySelectorAll('.page').forEach(x => x.classList.add('hidden'));
    document.querySelectorAll('.nav button').forEach(x => x.classList.remove('active'));
    document.getElementById('page-'+p).classList.remove('hidden');
    if(document.getElementById('nav-'+p)) document.getElementById('nav-'+p).classList.add('active');
    if(p === 'admin') loadAdminUserList();
  }

  async function loadAdminUserList() {
    const { data } = await supabaseClient.from('users').select('*');
    document.getElementById('adminUserList').innerHTML = data.map(u => `
      <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
        <span>${u.nickname} (${u.username})</span>
        ${u.role !== 'admin' ? `<button onclick="deleteUser('${u.id}', event)" style="width:auto; padding:2px 8px; background:red; font-size:11px;">åˆ é™¤ç”¨æˆ·</button>` : ''}
      </div>
    `).join('');
  }

  async function deleteUser(uid, e) {
    if(!confirm('åˆ æ‰ç”¨æˆ·åŠå…¶è®°å½•ï¼Ÿ')) return;
    await supabaseClient.from('users').delete().eq('id', uid);
    e.target.closest('div').remove();
  }

  function logout() { localStorage.clear(); location.reload(); }
  const savedUser = localStorage.getItem('qifei_user');
  if (savedUser) { currentUser = JSON.parse(savedUser); initApp(); }
  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('checkInBtn').addEventListener('click', doCheckIn);
</script>
</body>
</html>
